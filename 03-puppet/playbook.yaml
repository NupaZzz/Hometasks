- name: master
  hosts: master
  gather_facts: false
  tasks:
    - name: add puppetserver rep
      become: yes
      dnf:
        name: https://yum.puppet.com/puppet7-release-el-8.noarch.rpm  
        state: present
        disable_gpg_check: true
    
    - name: install puppetserver
      become: yes
      dnf:
        name: puppetserver
        state: present
    
    - name: get puppet config
      become: yes
      get_url:
        url: https://raw.githubusercontent.com/NupaZzz/Hometasks/master/03-puppet/puppetserver
        dest: /etc/sysconfig/
        mode: '0664'

    - name: get puppet config
      become: yes
      get_url:
        url: https://raw.githubusercontent.com/NupaZzz/Hometasks/master/03-puppet/puppet.conf
        dest: /etc/puppetlabs/puppet/puppet.conf
        mode: '0664'

    - name: add autosign
      become: yes
      get_url:
        url: https://raw.githubusercontent.com/NupaZzz/Hometasks/master/03-puppet/autosign.conf
        dest: /etc/puppetlabs/puppet/autosign.conf
        mode: '0664'

    - name: create r10k
      become: yes
      file:
        path: /etc/puppetlabs/r10k
        state: directory
        mode: '0755'

    - name: start ppserver
      become: yes
      service:
        name: puppetserver
        state: started

    - name: open port
      become: yes
      firewalld:
        zone: public
        port: 8140/tcp
        permanent: true
        state: enabled
    
    - name: restart firewalld
      become: yes
      service:
        name: firewalld
        state: restarted

- name: slave
  hosts: slave
  gather_facts: false
  tasks:
    - name: add puppetserver rep
      become: yes
      dnf:
        name: https://yum.puppet.com/puppet7-release-el-8.noarch.rpm  
        state: present
        disable_gpg_check: true
    
    - name: install puppet agent
      become: yes
      dnf:
        name: puppet-agent
        state: present
    
    - name: rework hosts
      become: yes
      lineinfile:
        path: /etc/hosts
        line: "192.168.30.10 master master"
        state: present
    
    - name: get puppet config
      become: yes
      get_url:
        url: https://raw.githubusercontent.com/NupaZzz/Hometasks/master/03-puppet/puppet.conf
        dest: /etc/puppetlabs/puppet/puppet.conf
        mode: '0664'

    - name: start ppserver
      become: yes
      service:
        name: puppet
        state: started

    - name: open port
      become: yes
      firewalld:
        zone: public
        port: 8140/tcp
        permanent: true
        state: enabled
    
    - name: restart firewalld
      become: yes
      service:
        name: firewalld
        state: restarted


